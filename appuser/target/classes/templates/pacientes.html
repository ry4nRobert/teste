<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/pacientes-styles.css?v=1.0}" />
    <title>Pacientes - MedLink</title>
</head>
<body>
    <header>
        <nav class="nav-bar">
            <div class="logo">
                <h1>MedLink</h1> 
            </div>

            <div class="nav-list">
                <ul>
                    <li class="nav-item"><a th:href="@{/home}" class="nav-link">Home</a></li>
                    <li class="nav-item"><a th:href="@{/pacientes}" class="nav-link active">Pacientes</a></li>
                    <li class="nav-item"><a th:href="@{/configuracoes}" class="nav-link">Configura√ß√µes</a></li>
                </ul>
            </div>

            <div class="exit-button">
                <button><a th:href="@{/login}">Sair</a></button>
            </div>

            <div class="mobile-menu-icon">
                <button onclick="menuShow()">
                    <svg class="icon" id="icon-menu" xmlns="http://www.w3.org/2000/svg" height="36px" viewBox="0 0 24 24" width="36px" fill="#FFFFFF">
                        <path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                    <svg class="icon" id="icon-close" style="display:none;" xmlns="http://www.w3.org/2000/svg" height="36px" viewBox="0 0 24 24" width="36px" fill="#FFFFFF">
                        <path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                    </svg>
                </button>
            </div>
        </nav>

        <div class="mobile-menu">
            <ul>
                <li class="nav-item"><a th:href="@{/home}" class="nav-link">Home</a></li>
                <li class="nav-item"><a th:href="@{/pacientes}" class="nav-link active">Pacientes</a></li>
                <li class="nav-item"><a th:href="@{/configuracoes}" class="nav-link">Configura√ß√µes</a></li>
            </ul>
            <div class="exit-button">
                <button><a th:href="@{/login}">Sair</a></button>
            </div>
        </div>
    </header>

    <main class="patients-main">
        <!-- Header da P√°gina de Pacientes -->
        <div class="patients-header">
            <div class="header-content">
                <h1>Pacientes</h1>
                <p>Gerencie seus pacientes e visualize informa√ß√µes importantes</p>
            </div>
            <div class="header-actions">
                <form class="search-form" th:action="@{/pacientes}" method="get">
                    <div class="search-container">
                        <input type="text" name="q" placeholder="Buscar por nome ou CPF" class="search-input"/>
                        <button type="submit" class="search-button">Buscar</button>
                    </div>
                </form>
                <button class="add-patient-btn" onclick="togglePatientForm()">
                    <span>+</span>
                    Adicionar Paciente
                </button>
            </div>
        </div>

        <!-- Formul√°rio de Adicionar Paciente -->
        <form id="patient-form" class="patient-form" th:action="@{/pacientes}" method="post" style="display: none;">
            <h3>Novo Paciente</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="patient-nome" class="form-label">Nome Completo *</label>
                    <input type="text" id="patient-nome" name="nome" class="form-input" required />
                </div>
                
                <div class="form-group">
                    <label for="patient-idade" class="form-label">Idade</label>
                    <input type="number" id="patient-idade" name="idade" min="0" class="form-input" />
                </div>
                
                <div class="form-group">
                    <label for="patient-cpf" class="form-label">CPF</label>
                    <input type="text" id="patient-cpf" name="cpf" class="form-input" placeholder="000.000.000-00" />
                </div>
                
                <div class="form-group full-width">
                    <label for="patient-alergias" class="form-label">Alergias</label>
                    <input type="text" id="patient-alergias" name="alergias" class="form-input" placeholder="Lista de alergias conhecidas" />
                </div>
                
                <div class="form-group full-width">
                    <label for="patient-cirurgias" class="form-label">Hist√≥rico de Cirurgias</label>
                    <input type="text" id="patient-cirurgias" name="historicoCirurgias" class="form-input" placeholder="Cirurgias realizadas anteriormente" />
                </div>
                
                <div class="form-group full-width">
                    <label for="patient-observacoes" class="form-label">Observa√ß√µes</label>
                    <textarea id="patient-observacoes" name="observacoes" rows="3" class="form-textarea" placeholder="Observa√ß√µes importantes sobre o paciente"></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Salvar Paciente</button>
                <button type="button" class="btn btn-secondary" onclick="togglePatientForm()">Cancelar</button>
            </div>
        </form>

        <!-- Lista de Pacientes -->
        <div class="patients-container">
            <div class="patients-grid" th:if="${not pacientes.empty}">
                <!-- Card de paciente para cada paciente na lista -->
                <div class="patient-card" th:each="paciente : ${pacientes}">
                    <div class="patient-header">
                        <div class="patient-avatar">
                            <span th:text="${#strings.substring(paciente.nome, 0, 1)} + ${#strings.substring(paciente.nome, #strings.indexOf(paciente.nome, ' ') + 1, #strings.indexOf(paciente.nome, ' ') + 2)}">PS</span>
                        </div>
                        <div class="patient-info">
                            <h3 class="patient-name" th:text="${paciente.nome}">Nome do Paciente</h3>
                            <p class="patient-details">
                                <span th:if="${paciente.idade != null}" th:text="${paciente.idade} + ' anos'">Idade</span>
                                <span th:if="${paciente.idade != null and paciente.cpf != null}"> ‚Ä¢ </span>
                                <span th:if="${paciente.cpf != null}" th:text="'CPF: ' + ${paciente.cpf}">CPF</span>
                            </p>
                        </div>
                        <div class="patient-status active">
                            Ativo
                        </div>
                    </div>
                    
                    <div class="patient-summary">
                        <div class="summary-item" th:if="${paciente.alergias != null}">
                            <span class="label">Alergias:</span>
                            <span class="value" th:text="${paciente.alergias}">Alergias</span>
                        </div>
                        <div class="summary-item" th:if="${paciente.historicoCirurgias != null}">
                            <span class="label">Cirurgias:</span>
                            <span class="value" th:text="${paciente.historicoCirurgias}">Cirurgias</span>
                        </div>
                        <div class="summary-item" th:if="${paciente.observacoes != null}">
                            <span class="label">Observa√ß√µes:</span>
                            <span class="value" th:text="${paciente.observacoes}">Observa√ß√µes</span>
                        </div>
                    </div>

                    <div class="patient-actions">
                        <button class="btn-action view-btn" th:onclick="'viewPatientDetails(' + ${paciente.id} + ')'">
                            Visualizar
                        </button>
                        <button class="btn-action delete-btn" th:onclick="'deletePatient(' + ${paciente.id} + ')'">
                            Excluir
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estado vazio -->
            <div class="empty-state" th:if="${pacientes.empty}">
                <div class="empty-icon">üë•</div>
                <h3>Nenhum paciente cadastrado</h3>
                <p>Comece adicionando seu primeiro paciente para gerenciar suas informa√ß√µes m√©dicas.</p>
                <button class="btn btn-primary" onclick="togglePatientForm()">
                    Adicionar Primeiro Paciente
                </button>
            </div>
        </div>
    </main>

    <!-- Modal de Detalhes do Paciente -->
    <div id="patient-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes do Paciente</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Conte√∫do ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Controle do formul√°rio de paciente
        function togglePatientForm() {
            const form = document.getElementById('patient-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            
            if (form.style.display === 'block') {
                window.scrollTo({ top: form.offsetTop - 20, behavior: 'smooth' });
            }
        }

        // Modal functions
        function viewPatientDetails(patientId) {
            // Em uma aplica√ß√£o real, voc√™ faria uma requisi√ß√£o AJAX para buscar os dados
            // Aqui vamos simular com os dados j√° carregados na p√°gina
            const modal = document.getElementById('patient-modal');
            const modalBody = document.getElementById('modal-body');
            
            // Encontrar o card do paciente pelo ID (em uma aplica√ß√£o real, voc√™ teria os dados completos)
            const patientCard = document.querySelector(`[onclick*="viewPatientDetails(${patientId})"]`).closest('.patient-card');
            const patientName = patientCard.querySelector('.patient-name').textContent;
            const patientDetails = patientCard.querySelector('.patient-details').textContent;
            const alergias = patientCard.querySelector('.summary-item:nth-child(1) .value')?.textContent || 'N√£o informado';
            const cirurgias = patientCard.querySelector('.summary-item:nth-child(2) .value')?.textContent || 'N√£o informado';
            const observacoes = patientCard.querySelector('.summary-item:nth-child(3) .value')?.textContent || 'N√£o informado';
            
            modalBody.innerHTML = `
                <div class="patient-detail">
                    <h4>${patientName}</h4>
                    <p><strong>${patientDetails}</strong></p>
                    <div class="detail-section">
                        <h5>Informa√ß√µes M√©dicas</h5>
                        <p><strong>Alergias:</strong> ${alergias}</p>
                        <p><strong>Hist√≥rico de Cirurgias:</strong> ${cirurgias}</p>
                        <p><strong>Observa√ß√µes:</strong> ${observacoes}</p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('patient-modal').style.display = 'none';
        }

        function deletePatient(patientId) {
            if (confirm('Tem certeza que deseja excluir este paciente? Esta a√ß√£o n√£o pode ser desfeita.')) {
                // Criar um formul√°rio din√¢mico para enviar a requisi√ß√£o POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/pacientes/${patientId}/excluir`;
                
                // Adicionar CSRF token (se estiver usando Spring Security)
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                
                if (csrfToken && csrfHeader) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('patient-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // M√°scara para CPF
        const cpfInput = document.getElementById('patient-cpf');
        if (cpfInput) {
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                
                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                }
                e.target.value = value;
            });
        }

        // Mostrar mensagem de sucesso se existir
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('success')) {
            alert('Paciente cadastrado com sucesso!');
            // Limpar a URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        if (urlParams.has('delete')) {
            alert('Paciente exclu√≠do com sucesso!');
            // Limpar a URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>

    <script th:src="@{/js/script.js}"></script>
</body>
</html>